import { WebSocketServer } from "ws";
const wss=new WebSocketServer({port:process.env.PORT||8080});
const rooms={},history={},ranks={};
function send(ws,obj){ws.readyState===1&&ws.send(JSON.stringify(obj))}
function bcast(room,obj){
  if(!rooms[room])return;
  rooms[room].forEach(c=>{if(c.ws.readyState===1)c.ws.send(JSON.stringify(obj))})
}
wss.on("connection",ws=>{
  const client={ws,name:null,room:null,rank:"Member"};
  ws.on("message",msg=>{
    let d;try{d=JSON.parse(msg)}catch(_){return;}
    if(d.type==="join"){
      client.name=d.name;
      if(client.room&&rooms[client.room])rooms[client.room].delete(client);

      client.room=d.room;
      if(!rooms[d.room])rooms[d.room]=new Set();
      rooms[d.room].add(client);

      if(!ranks[d.room])ranks[d.room]={};
      if(!ranks[d.room][client.name]){
        ranks[d.room][client.name]=rooms[d.room].size===1?"Owner":"Member";
      }
      client.rank=ranks[d.room][client.name];

      send(ws,{type:"system",text:`Joined room: ${client.room}`});
      send(ws,{type:"rank",rank:client.rank});
      send(ws,{type:"history",messages:history[d.room]||[]});

      const users=[...rooms[d.room]].map(c=>({name:c.name,rank:c.rank}));
      bcast(client.room,{type:"userList",users});
      return;
    }
    if(d.type==="message"){
      if(!client.room)return;
      const entry={from:client.name,rank:client.rank,text:d.text};
      if(!history[client.room])history[client.room]=[];
      history[client.room].push(entry);
      if(history[client.room].length>200)history[client.room].shift();
      bcast(client.room,{type:"message",...entry});
      return;
    }
    if(d.type==="setRank"&&client.rank==="Owner"){
      ranks[client.room][d.user]=d.rank;
      const target=[...rooms[client.room]].find(c=>c.name===d.user);
      if(target)target.rank=d.rank;
      const users=[...rooms[client.room]].map(c=>({name:c.name,rank:c.rank}));
      bcast(client.room,{type:"userList",users});
      return;
    }
    if(d.type==="callRequest"&&client.room){
      const target=[...rooms[client.room]].find(c=>c.name===d.target);
      if(target)send(target.ws,{type:"incomingCall",from:client.name,video:d.video});
      return;
    }
    if(d.type==="callReply"){
      const target=[...rooms[client.room]].find(c=>c.name===d.target);
      if(target)send(target.ws,{type:"callReply",from:client.name,accepted:d.accepted,video:d.video});
      return;
    }
    if(d.type==="webrtc-offer"){
      const t=[...rooms[client.room]].find(c=>c.name===d.target);
      if(t)send(t.ws,{type:"webrtc-offer",from:client.name,offer:d.offer});
      return;
    }
    if(d.type==="webrtc-answer"){
      const t=[...rooms[client.room]].find(c=>c.name===d.target);
      if(t)send(t.ws,{type:"webrtc-answer",from:client.name,answer:d.answer});
      return;
    }
    if(d.type==="webrtc-ice"){
      const t=[...rooms[client.room]].find(c=>c.name===d.target);
      if(t)send(t.ws,{type:"webrtc-ice",from:client.name,candidate:d.candidate});
      return;
    }
    if(d.type==="callEnd"){
      const t=[...rooms[client.room]].find(c=>c.name===d.target);
      if(t)send(t.ws,{type:"callEnd",from:client.name});
      return;
    }
  });
  ws.on("close",()=>{
    if(client.room&&rooms[client.room]){
      rooms[client.room].delete(client);
      const users=[...rooms[client.room]].map(c=>({name:c.name,rank:c.rank}));
      bcast(client.room,{type:"userList",users});
    }
  });
});
console.log("Chat + Signaling Server Running");
